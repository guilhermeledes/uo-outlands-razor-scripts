# Name: Minning
# Author: Guilherme Ledes (based on Jaseowns`s script)
# Requirements:
#   - Pickeaxe
#   - 40 Magery to escape
#   - rune or runebook with default rune to escape
#   - 100 Hiding to escape
#   - 100 Tracking to detect reds
# Hint: 
#   - Add the following overheadmessages to your miner character's profile
#   - C:\Program Files (x86)\Ultima Online Outlands\ClassicUO\Data\Plugins\Assistant\Profiles\miner_profile.xml
#	<overheadmessages>
#		<overheadmessage searchtext="The world will save" message="Game will save soon..." hue="18" />
#		<overheadmessage searchtext="The world is saving" message="Game saving..." hue="18" />
#		<overheadmessage searchtext="World save complete" message="Game saved!" hue="18" />
#		<overheadmessage searchtext="Now tracking:" message="PK {3} {4} {5}" hue="33" />
#		<overheadmessage searchtext="Your concentration is disturbed, thus ruining thy spell." message="INTERUPTED" hue="53" />
#		<overheadmessage searchtext="That is too far away" message="OUT OF RANGE" hue="53" />
#		<overheadmessage searchtext="You have been revealed!" message="REVEALED" hue="33" />
#		<overheadmessage searchtext="You loosen some rocks" message="Fail..." hue="43" />
#		<overheadmessage searchtext="You do not see any harvestable resources nearby" message="Move to next spot" hue="53" />
#		<overheadmessage searchtext="You dig some iron ore and put it in your backpack." message="Iron" hue="2875" />
#		<overheadmessage searchtext="You dig some dull copper ore and put it in your backpack." message="Dull Copper" hue="2419" />
#		<overheadmessage searchtext="You dig some shadow iron ore and put it in your backpack." message="Shadow Iron" hue="2406" />
#		<overheadmessage searchtext="You dig some copper ore and put it in your backpack." message="Copper" hue="2413" />
#		<overheadmessage searchtext="You dig some bronze ore and put it in your backpack." message="Bronze" hue="2418" />
#		<overheadmessage searchtext="You dig some golden ore and put it in your backpack." message="Golden" hue="2213" />
#		<overheadmessage searchtext="You dig some agapite ore and put it in your backpack." message="Agapite" hue="2425" />
#		<overheadmessage searchtext="You dig some verite ore and put it in your backpack." message="Verite" hue="2207" />
#		<overheadmessage searchtext="You dig some valorite ore and put it in your backpack." message="Valorite" hue="2219" />
#		<overheadmessage searchtext="You dig some avarite ore and put it your backpack. " message="Avarite" hue="1763" />
#	</overheadmessages>

@setvar! recall_on_red_alert 0

if not findbuff "tracking hunting"
    overhead "Beging Tracking" 53
    skill 'tracking'
    waitforgump 4267467659
    gumpresponse 6
    waitforgump 4267467659
    gumpclose
endif

if not varexist recall_target
    overhead "Select your escape runebook" 88
    setvar recall_target
endif

if not listexists "miner_actions"
    createlist "miner_actions"
endif

if inlist "miner_actions" "red_alert"
    overhead "Red Alert!" 34
    if skill "Magery" >= 40 and recall_on_red_alert = 1
        overhead 'Recalling...'
        while not targetexists
            cast "Recall"
            wait 200
        endwhile
        target recall_target
    elseif skill "Hiding" >= 40
        useskill "Hiding"
    endif
    poplist "miner_actions" "red_alert"
    overhead "Stopping script..." 34
    stop
endif

clearsysmsg 
if diffweight <= 30
    if diffweight <= 30
        overhead "Too heavy... Go to smelt some ores" 34
        replay
    endif
endif

if rhandempty ?? 0 
    if findtype "pickaxe" backpack
        dclicktype 'pickaxe' backpack
        wait 1000
    endif
endif
            
if rhandempty ?? 0 
    overhead "No more pickaxe!" 34
    replay
endif

overhead 'Mining' 68
hotkey 'Use item in hand'
wait 250
for 30
    wait 250
    if insysmsg 'world is saving'
        for 30
            overhead 'Waiting for world save...'
            wait 1000
            if insysmsg 'save complete'
                overhead 'Save complete - continue on!' 88
                replay
            elseif insysmsg "now tracking"
                pushlist "miner_actions" "red_alert"
                replay
            endif
        endfor
    elseif insysmsg "now tracking"
        pushlist "miner_actions" "red_alert"
        replay
    elseif hp < maxhp
        if not varexist recall_target
          overhead "Select your escape rune" 88
          setvar recall_target
        endif
        if insysmsg "now tracking"
          overhead 'Recalling...'
          while not targetexists
              cast "Recall"
              wait 200
          endwhile
          target recall_target
          stop
        endif
    elseif rhandempty ?? 0 
        overhead "Broke pickaxe" 34
        replay
    elseif insysmsg 'You do not see any'
        overhead 'Move to next spot' 88
        wait 250
        replay
    elseif insysmsg "harvesting is not allowed"
        overhead 'Move out of town...'
        wait 1000
        replay
    elseif insysmsg "travel"
        overhead 'Waiting for travel...'
        wait 1000
        replay
    else
        if insysmsg "any harvestable" or insysmsg "miner_actions"
            // No Ore
            overhead 'Move to next spot' 88
            replay
        elseif insysmsg "skillgain" or insysmsg "harvesting is not allowed"
            // Gained skill
            replay
        elseif insysmsg "world is saving" or insysmsg 'World save complete'
            // World Save
            replay
        elseif insysmsg "You loosen"
            // Failed
            replay
        elseif insysmsg "You dig"
            // Success
            replay
        elseif insysmsg "You must wait"
            // Wait message
            overhead 'You must wait..' 34
            wait 500
            replay
        endif
    endif
endfor

if insysmsg "You must wait"
    // Wait message
    overhead 'You must wait..' 34
    wait 500
    replay
endif

overhead 'Captcha break!' 34
for 20
    overhead 'Awaiting Captcha...' 34
    wait 1000
    if insysmsg 'Captcha successful'
        overhead 'Success - continue on!' 88
        wait 1000
        replay
    endif
endfor
overhead 'Stopping script' 34